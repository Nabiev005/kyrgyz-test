const persons = [
  {
    name: "–ß—ã–Ω–≥—ã–∑ –ê–π—Ç–º–∞—Ç–æ–≤",
    img: "185e1bf93150ce613c6258b60d9bbf45_MNWLZVZkVWHXFwqhj4WNIiFrNeO5f43s.jpg",
    questions: [
      { q: "–û–Ω –∏–∑–≤–µ—Å—Ç–µ–Ω –∫–∞–∫ –ø–∏—Å–∞—Ç–µ–ª—å." },
      { q: "–ï–≥–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Å–≤—è–∑–∞–Ω—ã —Å –∫—ã—Ä–≥—ã–∑—Å–∫–æ–π –∫—É–ª—å—Ç—É—Ä–æ–π." },
      { q: "–ê–≤—Ç–æ—Ä –∑–Ω–∞–º–µ–Ω–∏—Ç–æ–≥–æ —Ä–æ–º–∞–Ω–∞ '–ò –¥–æ–ª—å—à–µ –≤–µ–∫–∞ –¥–ª–∏—Ç—Å—è –¥–µ–Ω—å'." }
    ]
  },
  {
    name: "–ö—É—Ä–º–∞–Ω–∂–∞–Ω –î–∞—Ç–∫–∞",
    img: "49709328728a190deef60bc049e8dd1b_11111-63c15d5bb0b3c.jpg",
    questions: [
      { q: "–û–Ω–∞ –∏–∑–≤–µ—Å—Ç–Ω–∞ –∫–∞–∫ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–µ—è—Ç–µ–ª—å." },
      { q: "–ó–∞—â–∏—â–∞–ª–∞ –∏–Ω—Ç–µ—Ä–µ—Å—ã –∫—ã—Ä–≥—ã–∑—Å–∫–æ–≥–æ –Ω–∞—Ä–æ–¥–∞." },
      { q: "–ñ–∏–ª–∞ –≤ XIX –≤–µ–∫–µ." }
    ]
  },
  {
    name: "–¢–æ–∫—Ç–æ–≥—É–ª –°–∞—Ç—ã–ª–≥–∞–Ω–æ–≤",
    img: "a659b82608b0113abc967dc60ec48eb5_i_id=6462042a9213889d6c26825f97a6131c_l-5234987-images-thumbs&n=13.webp",
    questions: [
      { q: "–û–Ω –∏–∑–≤–µ—Å—Ç–µ–Ω –∫–∞–∫ –ø–µ–≤–µ—Ü –∏ –∫–æ–º–ø–æ–∑–∏—Ç–æ—Ä." },
      { q: "–í–∫–ª–∞–¥ –≤ –∫—ã—Ä–≥—ã–∑—Å–∫—É—é –º—É–∑—ã–∫—É –∏ –∫—É–ª—å—Ç—É—Ä—É." },
      { q: "–°–æ–∑–¥–∞–ª –º–Ω–æ–≥–æ –Ω–∞—Ä–æ–¥–Ω—ã—Ö –ø–µ—Å–µ–Ω." }
    ]
  },
  {
    name: "–ö–∞—Å—ã–º –¢—ã–Ω—ã—Å—Ç–∞–Ω–æ–≤",
    img: "a4d9197343038cb2f158c44a8ff73657_742621669722447_big-1.jpg",
    questions: [
      { q: "–ü–æ—ç—Ç –∏ –ø–µ–¥–∞–≥–æ–≥." },
      { q: "–í–∫–ª–∞–¥ –≤ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É –∏ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ." },
      { q: "–ó–Ω–∞–º–µ–Ω–∏—Ç —Å–≤–æ–∏–º–∏ —Å—Ç–∏—Ö–∞–º–∏ –æ –ø—Ä–∏—Ä–æ–¥–µ." }
    ]
  },
  {
    name: "–ê–ª—ã–∫—É–ª –û—Å–º–æ–Ω–æ–≤",
    img: "e6a6e6656e8763f597ea34f3952fea2f_578859.1.1373872676.jpg",
    questions: [
      { q: "–ò–∑–≤–µ—Å—Ç–µ–Ω –∫–∞–∫ –ø–æ—ç—Ç." },
      { q: "–ï–≥–æ —Å—Ç–∏—Ö–∏ –æ –ª—é–±–≤–∏ –∏ –ø—Ä–∏—Ä–æ–¥–µ." },
      { q: "–í–∫–ª–∞–¥ –≤ –∫—ã—Ä–≥—ã–∑—Å–∫—É—é –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É." }
    ]
  },
  {
    name: "–¢–æ–≥–æ–ª–æ–∫ –ú–æ–ª–¥–æ",
    img: "63f8209b5621548f139e8e2daf38ec57_i_id=45a201d54b0218c8769546330618de727e499021-5859268-images-thumbs&n=13.webp",
    questions: [
      { q: "–ü–æ—ç—Ç –∏ –∞–∫—ã–Ω." },
      { q: "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ —Å–≤—è–∑–∞–Ω–æ —Å –Ω–∞—Ä–æ–¥–Ω—ã–º–∏ —Å–∫–∞–∑–∞–Ω–∏—è–º–∏." },
      { q: "–í–∫–ª–∞–¥ –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫—É–ª—å—Ç—É—Ä—ã." }
    ]
  },
  {
    name: "–ò—Å—Ö–∞–∫ –†–∞–∑–∑–∞–∫–æ–≤",
    img: "ea6019dabd2374bdd6725bae515e1918_image_5dfa10c869b50.jpg",
    questions: [
      { q: "–ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–µ—è—Ç–µ–ª—å." },
      { q: "–†–∞–±–æ—Ç–∞–ª –Ω–∞ –±–ª–∞–≥–æ —Å—Ç—Ä–∞–Ω—ã." },
      { q: "–ó–Ω–∞–º–µ–Ω–∏—Ç —Ä–µ—Ñ–æ—Ä–º–∞–º–∏ –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ–º –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è." }
    ]
  }
];

/* DOM */
const personImg = document.getElementById('personImg');
const tilesEl = document.getElementById('tiles');
const colsSelect = document.getElementById('colsSelect');
const openedEl = document.getElementById('opened');
const totalEl = document.getElementById('total');
const timeEl = document.getElementById('time');
const questionArea = document.getElementById('questionArea');
const guessInput = document.getElementById('guessInput');
const guessBtn = document.getElementById('guessBtn');
const nextPersonBtn = document.getElementById('nextPersonBtn');
const revealAllBtn = document.getElementById('revealAllBtn');
const hintBtn = document.getElementById('hintBtn');
const qIndexEl = document.getElementById('qIndex');
const mistakesEl = document.getElementById('mistakes');
const roundResultEl = document.getElementById('roundResult');
const musicFile = document.getElementById('musicFile');
const musicPlayBtn = document.getElementById('musicPlayBtn');

/* VARS */
let cols = Number(colsSelect.value);
let tiles = [];
let revealed = new Set();
let opened = 0;
let totalTiles = cols * cols;
let currentIndex = 0;
let current = null;
let currentQ = 0;
let mistakes = 0;
let timer = null;
let seconds = 0;
let bgAudio = null;
let bgPlaying = false;

function normalize(s){
  return s.trim().toLowerCase().replace(/\s+/g,' ');
}

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* TILES */
function createTilesGrid(nCols){
  cols = nCols;
  document.documentElement.style.setProperty('--cols', cols);

  tilesEl.innerHTML = '';
  tiles = [];
  revealed.clear();
  opened = 0;
  openedEl.textContent = opened;

  totalTiles = cols * cols;
  totalEl.textContent = totalTiles;

  for(let i=0;i<totalTiles;i++){
    const t = document.createElement('div');
    t.className = 'tile';
    t.dataset.idx = i;
    t.addEventListener('click', ()=> revealTile(i));
    tilesEl.appendChild(t);
    tiles.push(t);
  }
}

function revealTile(idx){
  if(revealed.has(idx)) return;
  revealed.add(idx);

  const t = tiles[idx];
  if(t) t.classList.add('revealed');

  opened++;
  openedEl.textContent = opened;
}

function revealRandomTiles(n){
  const closed = [];
  for(let i=0;i<totalTiles;i++){
    if(!revealed.has(i)) closed.push(i);
  }
  shuffle(closed);

  for(let i=0;i<Math.min(n, closed.length); i++){
    revealTile(closed[i]);
  }
}

function revealAllTiles(){
  for(let i=0;i<totalTiles;i++){
    revealTile(i);
  }
}

/* TIMER */
function startTimer(){
  clearInterval(timer);
  seconds = 0;
  timeEl.textContent = '00:00';

  timer = setInterval(()=>{
    seconds++;
    const mm = String(Math.floor(seconds/60)).padStart(2,'0');
    const ss = String(seconds%60).padStart(2,'0');
    timeEl.textContent = `${mm}:${ss}`;
  },1000);
}

function stopTimer(){
  clearInterval(timer);
}

/* QUESTIONS */
function renderQuestion() {
  if(currentQ >= current.questions.length) {
    questionArea.innerHTML = `<div class="questionText">–í—Å–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∑–∞–¥–∞–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–≥–∞–¥–∞—Ç—å!</div>`;
    qIndexEl.textContent = current.questions.length;
    return;
  }

  questionArea.innerHTML = `<div class="questionText">–ü–æ–¥—Å–∫–∞–∑–∫–∞ ${currentQ + 1}: ${current.questions[currentQ].q}</div>`;
  qIndexEl.textContent = currentQ + 1;
}

/* GUESS */
function attemptGuess(){
  const ans = guessInput.value.trim();
  if(!ans) return;

  if(normalize(ans) === normalize(current.name)){
    revealAllTiles();
    stopTimer();
    roundResultEl.textContent = `–í–µ—Ä–Ω–æ ‚Äî —ç—Ç–æ ${current.name}!`;
    setTimeout(nextPerson, 2000);
  } else {
    mistakes++;
    mistakesEl.textContent = mistakes;
    roundResultEl.textContent = "–ù–µ–≤–µ—Ä–Ω–æ ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë.";
  }

  guessInput.value = "";
}

/* PERSONS */
function loadPerson(index){
  currentIndex = index;
  current = persons[index];

  personImg.src = current.img;

  createTilesGrid(cols);

  currentQ = 0;
  mistakes = 0;

  qIndexEl.textContent = 0;
  mistakesEl.textContent = 0;
  roundResultEl.textContent = "‚Äî";

  renderQuestion();
  startTimer();
}

function nextPerson(){
  if(currentIndex + 1 < persons.length){
    loadPerson(currentIndex + 1);
  } else {
    stopTimer();
    questionArea.innerHTML = `<div class="questionText">üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ—Ö ${persons.length} —á–µ–ª–æ–≤–µ–∫!</div>`;
    roundResultEl.textContent = "–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!";
  }
}

/* MUSIC */
musicFile.addEventListener('change', e=>{
  const f = e.target.files?.[0];
  if(!f) return;

  if(bgAudio){
    bgAudio.pause();
    bgAudio.src = "";
  }

  bgAudio = new Audio(URL.createObjectURL(f));
  bgAudio.loop = true;
  bgPlaying = false;
  musicPlayBtn.textContent = "–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏";
});

musicPlayBtn.addEventListener('click', async ()=>{
  if(!bgAudio){
    alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –º—É–∑—ã–∫–∏");
    return;
  }

  try{
    if(!bgPlaying){
      await bgAudio.play();
      bgPlaying = true;
      musicPlayBtn.textContent = "–ü–∞—É–∑–∞";
    } else {
      bgAudio.pause();
      bgPlaying = false;
      musicPlayBtn.textContent = "–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏";
    }
  } catch(e){
    alert("–ë—Ä–∞—É–∑–µ—Ä –∑–∞–ø—Ä–µ—Ç–∏–ª –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ.");
  }
});

/* BUTTONS */
guessBtn.addEventListener('click', attemptGuess);
guessInput.addEventListener('keydown', e=>{
  if(e.key === 'Enter') attemptGuess();
});

nextPersonBtn.addEventListener('click', nextPerson);
revealAllBtn.addEventListener('click', revealAllTiles);
hintBtn.addEventListener('click', ()=>{
  renderQuestion();
  currentQ++;
  revealRandomTiles(2);
});
colsSelect.addEventListener('change', e=>{
  createTilesGrid(Number(e.target.value));
});

/* INIT */
(function init(){
  createTilesGrid(cols);
  loadPerson(0);
})();
